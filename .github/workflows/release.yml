name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      version:
        description: 'Specific version (optional, overrides bump_type)'
        required: false

permissions:
  contents: write

jobs:
  bump-version:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        id: bump
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")

          if [ -n "${{ github.event.inputs.version }}" ]; then
            NEW_VERSION="${{ github.event.inputs.version }}"
          else
            BUMP_TYPE="${{ github.event.inputs.bump_type }}"
            case "$BUMP_TYPE" in
              patch)
                NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
                ;;
              minor)
                NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{$(NF-1) = $(NF-1) + 1; $NF = 0;} 1' | sed 's/ /./g')
                ;;
              major)
                NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{$1 = $1 + 1; $(NF-1) = 0; $NF = 0;} 1' | sed 's/ /./g')
                ;;
            esac
          fi

          echo "Bumping version from $CURRENT_VERSION to $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Update package.json
          npm version $NEW_VERSION --no-git-tag-version

          # Update Cargo.toml
          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" src-tauri/Cargo.toml

          # Update tauri.conf.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$NEW_VERSION\"/" src-tauri/tauri.conf.json

          # Update Chocolatey nuspec
          sed -i "s/<version>.*<\/version>/<version>$NEW_VERSION<\/version>/" packages/chocolatey/prompt-pad.nuspec

      - name: Commit and tag
        run: |
          VERSION="${{ steps.bump.outputs.version }}"
          git add package.json package-lock.json src-tauri/Cargo.toml src-tauri/tauri.conf.json packages/chocolatey/prompt-pad.nuspec
          git commit -m "chore: bump version to $VERSION"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin main
          git push origin "v$VERSION"

  create-release:
    runs-on: ubuntu-latest
    needs: [bump-version]
    if: always() && (github.event_name == 'push' || needs.bump-version.result == 'success')
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', needs.bump-version.outputs.version) || github.ref }}

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ needs.bump-version.outputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: PromptPad v${{ steps.get_version.outputs.version }}
          body: |
            ## PromptPad v${{ steps.get_version.outputs.version }}

            A Spotlight-style prompt launcher for Windows and macOS.

            ### Installation

            **macOS (Homebrew) - Recommended:**
            ```bash
            brew tap mschnecke/prompt-pad
            brew install --cask prompt-pad
            ```

            **macOS (Direct Download):**
            Download the `.pkg` installer for your architecture:
            - Apple Silicon (M1/M2/M3/M4/M5): `PromptPad_${{ steps.get_version.outputs.version }}_aarch64.pkg`
            - Intel: `PromptPad_${{ steps.get_version.outputs.version }}_x64.pkg`

            **Windows (Chocolatey):**
            ```powershell
            choco source add -n="github-prompt-pad" -s="https://www.myget.org/F/mschnecke/api/v3/index.json"
            choco install prompt-pad"
            ```

            **Windows (Direct Download):**
            Download `PromptPad_${{ steps.get_version.outputs.version }}_x64_en-US.msi` from assets below.

            ### Quick Start

            - **Default hotkey:** `Cmd+Shift+P` (macOS) / `Ctrl+Shift+P` (Windows)
            - **Prompts stored in:** `~/.prompt-pad/prompts/`
            - **Settings stored in:** `~/.prompt-pad.json`

            ### Post-Installation (macOS)

            Grant Accessibility permissions:
            1. Open System Settings > Privacy & Security > Accessibility
            2. Enable PromptPad in the list

            ### Changelog
            See [CHANGELOG.md](https://github.com/mschnecke/prompt-pad/blob/main/CHANGELOG.md) for details.
          draft: true
          prerelease: false

  build-tauri:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin --bundles app'
            arch: 'aarch64'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin --bundles app'
            arch: 'x64'
          - platform: 'windows-latest'
            args: '--bundles msi'
            arch: 'x64'

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: v${{ needs.create-release.outputs.version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: ${{ matrix.args }}

      # Build macOS .pkg installer from .app bundle
      - name: Build macOS pkg installer
        if: matrix.platform == 'macos-latest'
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          ARCH="${{ matrix.arch }}"

          chmod +x packages/macos/build-package.sh
          chmod +x packages/macos/postinstall
          ./packages/macos/build-package.sh "$VERSION" "$ARCH"

      # Upload macOS .pkg to release
      - name: Upload macOS pkg to release
        if: matrix.platform == 'macos-latest'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: ./dist/PromptPad_${{ needs.create-release.outputs.version }}_${{ matrix.arch }}.pkg

      # Upload Windows .msi to release
      - name: Upload Windows installer to release
        if: matrix.platform == 'windows-latest'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: ./src-tauri/target/release/bundle/msi/PromptPad_${{ needs.create-release.outputs.version }}_x64_en-US.msi

  publish-release:
    needs: [create-release, build-tauri]
    runs-on: ubuntu-latest
    steps:
      - name: Publish release
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: ${{ needs.create-release.outputs.release_id }},
              draft: false
            });

  update-homebrew:
    needs: [create-release, publish-release]
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Homebrew cask update
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          repository: mschnecke/homebrew-prompt-pad
          event-type: update-cask
          client-payload: '{"version": "${{ needs.create-release.outputs.version }}"}'

  update-chocolatey:
    needs: [create-release, publish-release]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows installer
        run: |
          $version = "${{ needs.create-release.outputs.version }}"
          Invoke-WebRequest -Uri "https://github.com/mschnecke/prompt-pad/releases/download/v$version/PromptPad_${version}_x64_en-US.msi" -OutFile "PromptPad-Setup.msi"

      - name: Generate checksum
        id: checksum
        run: |
          $hash = (Get-FileHash -Path "PromptPad-Setup.msi" -Algorithm SHA256).Hash
          echo "sha256=$hash" >> $env:GITHUB_OUTPUT

      - name: Update Chocolatey package
        run: |
          $version = "${{ needs.create-release.outputs.version }}"
          $sha256 = "${{ steps.checksum.outputs.sha256 }}"

          # Update chocolateyInstall.ps1
          $installScript = Get-Content packages/chocolatey/tools/chocolateyInstall.ps1 -Raw
          $installScript = $installScript -replace 'url64bit\s*=\s*''.*''', "url64bit = 'https://github.com/mschnecke/prompt-pad/releases/download/v$version/PromptPad_${version}_x64_en-US.msi'"
          $installScript = $installScript -replace 'checksum64\s*=\s*''.*''', "checksum64 = '$sha256'"
          Set-Content -Path packages/chocolatey/tools/chocolateyInstall.ps1 -Value $installScript

          # Update nuspec version
          $nuspec = Get-Content packages/chocolatey/prompt-pad.nuspec -Raw
          $nuspec = $nuspec -replace '<version>.*</version>', "<version>$version</version>"
          Set-Content -Path packages/chocolatey/prompt-pad.nuspec -Value $nuspec

      - name: Pack Chocolatey package
        run: |
          cd packages/chocolatey
          choco pack

      - name: Setup .NET for NuGet push
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Publish to MyGet
        env:
          MYGET_API_KEY: ${{ secrets.MYGET_API_KEY }}
        run: |
          $version = "${{ needs.create-release.outputs.version }}"
          dotnet nuget push "packages/chocolatey/prompt-pad.$version.nupkg" `
            --source "https://www.myget.org/F/mschnecke/api/v3/index.json" `
            --api-key $env:MYGET_API_KEY
