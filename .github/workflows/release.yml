name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          release_name: PromptPad v${{ steps.get_version.outputs.version }}
          body: |
            ## PromptPad v${{ steps.get_version.outputs.version }}

            A Spotlight-style prompt launcher for Windows and macOS.

            ### Installation

            **macOS (Homebrew) - Recommended:**
            ```bash
            brew tap mschnecke/prompt-pad
            brew install --cask prompt-pad
            ```

            **macOS (Direct Download):**
            Download the `.pkg` installer for your architecture:
            - Apple Silicon (M1/M2/M3): `PromptPad_${{ steps.get_version.outputs.version }}_aarch64.pkg`
            - Intel: `PromptPad_${{ steps.get_version.outputs.version }}_x64.pkg`

            **Windows (Chocolatey):**
            ```powershell
            choco source add -n="mschnecke" -s="https://www.myget.org/F/mschnecke/api/v3/index.json"
            choco install prompt-pad -s="mschnecke"
            ```

            **Windows (Direct Download):**
            Download `PromptPad_${{ steps.get_version.outputs.version }}_x64-setup.exe` from assets below.

            ### Quick Start

            - **Default hotkey:** `Cmd+Shift+P` (macOS) / `Ctrl+Shift+P` (Windows)
            - **Prompts stored in:** `~/.prompt-pad/prompts/`
            - **Settings stored in:** `~/.prompt-pad.json`

            ### Post-Installation (macOS)

            Grant Accessibility permissions:
            1. Open System Settings > Privacy & Security > Accessibility
            2. Enable PromptPad in the list

            ### Changelog
            See [CHANGELOG.md](https://github.com/mschnecke/prompt-pad/blob/main/CHANGELOG.md) for details.
          draft: true
          prerelease: false

  build-tauri:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            arch: 'aarch64'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            arch: 'x64'
          - platform: 'windows-latest'
            args: ''
            arch: 'x64'

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: ${{ matrix.args }}

      # Build macOS .pkg installer from .app bundle
      - name: Build macOS pkg installer
        if: matrix.platform == 'macos-latest'
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          ARCH="${{ matrix.arch }}"

          chmod +x packages/macos/build-package.sh
          chmod +x packages/macos/postinstall
          ./packages/macos/build-package.sh "$VERSION" "$ARCH"

      # Upload macOS .pkg to release
      - name: Upload macOS pkg to release
        if: matrix.platform == 'macos-latest'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./dist/PromptPad_${{ needs.create-release.outputs.version }}_${{ matrix.arch }}.pkg
          asset_name: PromptPad_${{ needs.create-release.outputs.version }}_${{ matrix.arch }}.pkg
          asset_content_type: application/octet-stream

      # Upload Windows .exe to release
      - name: Upload Windows installer to release
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./src-tauri/target/release/bundle/nsis/PromptPad_${{ needs.create-release.outputs.version }}_x64-setup.exe
          asset_name: PromptPad_${{ needs.create-release.outputs.version }}_x64-setup.exe
          asset_content_type: application/octet-stream

  publish-release:
    needs: [create-release, build-tauri]
    runs-on: ubuntu-latest
    steps:
      - name: Publish release
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: ${{ needs.create-release.outputs.release_id }},
              draft: false
            });

  update-homebrew:
    needs: [create-release, publish-release]
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Homebrew cask update
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          repository: mschnecke/homebrew-prompt-pad
          event-type: update-cask
          client-payload: '{"version": "${{ needs.create-release.outputs.version }}"}'

  update-chocolatey:
    needs: [create-release, publish-release]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows installer
        run: |
          $version = "${{ needs.create-release.outputs.version }}"
          Invoke-WebRequest -Uri "https://github.com/mschnecke/prompt-pad/releases/download/v$version/PromptPad_${version}_x64-setup.exe" -OutFile "PromptPad-Setup.exe"

      - name: Generate checksum
        id: checksum
        run: |
          $hash = (Get-FileHash -Path "PromptPad-Setup.exe" -Algorithm SHA256).Hash
          echo "sha256=$hash" >> $env:GITHUB_OUTPUT

      - name: Update Chocolatey package
        run: |
          $version = "${{ needs.create-release.outputs.version }}"
          $sha256 = "${{ steps.checksum.outputs.sha256 }}"

          # Update chocolateyInstall.ps1
          $installScript = Get-Content packages/chocolatey/tools/chocolateyInstall.ps1 -Raw
          $installScript = $installScript -replace 'url64bit\s*=\s*''.*''', "url64bit = 'https://github.com/mschnecke/prompt-pad/releases/download/v$version/PromptPad_${version}_x64-setup.exe'"
          $installScript = $installScript -replace 'checksum64\s*=\s*''.*''', "checksum64 = '$sha256'"
          Set-Content -Path packages/chocolatey/tools/chocolateyInstall.ps1 -Value $installScript

          # Update nuspec version
          $nuspec = Get-Content packages/chocolatey/prompt-pad.nuspec -Raw
          $nuspec = $nuspec -replace '<version>.*</version>', "<version>$version</version>"
          Set-Content -Path packages/chocolatey/prompt-pad.nuspec -Value $nuspec

      - name: Pack Chocolatey package
        run: |
          cd packages/chocolatey
          choco pack

      - name: Setup .NET for NuGet push
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Publish to MyGet
        env:
          MYGET_API_KEY: ${{ secrets.MYGET_API_KEY }}
        run: |
          $version = "${{ needs.create-release.outputs.version }}"
          dotnet nuget push "packages/chocolatey/prompt-pad.$version.nupkg" `
            --source "https://www.myget.org/F/mschnecke/api/v3/index.json" `
            --api-key $env:MYGET_API_KEY
