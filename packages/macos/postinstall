#!/bin/bash
# packages/macos/postinstall
# Runs after the .pkg installation completes

APP_PATH="/Applications/PromptPad.app"

# Remove quarantine attribute (allows app to run without Gatekeeper warning)
if [ -d "$APP_PATH" ]; then
    xattr -rd com.apple.quarantine "$APP_PATH" 2>/dev/null || true
fi

# Notify user about Accessibility permissions
osascript -e 'display notification "Please grant Accessibility permissions in System Settings > Privacy & Security > Accessibility" with title "PromptPad Installed" subtitle "One more step needed"' 2>/dev/null || true

# Launch PromptPad after installation
# Use open command to start the app in background as the current user
if [ -d "$APP_PATH" ]; then
    # Get the console user (the logged-in user, not root running the installer)
    CONSOLE_USER=$(stat -f "%Su" /dev/console)
    if [ -n "$CONSOLE_USER" ] && [ "$CONSOLE_USER" != "root" ]; then
        # Launch as the console user to ensure proper permissions and context
        sudo -u "$CONSOLE_USER" open "$APP_PATH" 2>/dev/null || true
    fi
fi

exit 0
